class Matrix{static Create(t){var e=new Array(t||0),r=t;if(arguments.length>1)for(var i=Array.prototype.slice.call(arguments,1);r--;)e[t-1-r]=this.Create.apply(this,i);return e}static Clone(t){var e,r;if(Array.isArray(t)){for(r=t.slice(0),e=0;e<r.length;e++)r[e]=this.Clone(r[e]);return r}if("object"==typeof t)throw"Cannot clone array containing an object!";return t}static MemCopy(t,e,r,i,s){for(var a=0;a<s;a++)t[e+a]=r[i+a]}static Copy2D(t,e,r,i){if(i>=0&i<e.length)for(var s=0;s<t.length;s++)this.MemCopy(t[s],0,e[s],r,t[0].length)}static Copy2DOffset(t,e,r,i){if(i>=0&i<t.length&e.length>0)for(var s=0;s<e.length;s++)this.MemCopy(t[s],r,e[s],0,e[0].length)}static Transpose(t){var e=t.length,r=t[0].length;if(e>1&&r>1){for(var i=this.Create(r,e),s=0;s<e;s++)for(var a=0;a<r;a++)i[a][s]=t[s][a];return i}if(e>1&&1==r){for(i=this.Create(1,e),s=0;s<e;s++)i[s]=t[s][0];return[i]}if(r>1&&1==e){for(i=this.Create(r,1),a=0;a<r;a++)i[a][0]=[t[0][a]];return i}}static Multiply(t,e){var r=t[0].length,i=t.length,s=e[0].length;if(r==e.length){for(var a=this.Create(i,s),h=0;h<i;h++)for(var n=0;n<s;n++){a[h][n]=0;for(var l=0;l<r;l++)a[h][n]+=t[h][l]*e[l][n]}return a}}static Product(t,e){var r=t[0].length,i=t.length,s=e[0].length,a=e.length;if(r==s&&i==a){for(var h=this.Create(i,r),n=0;n<i;n++)for(var l=0;l<r;l++)h[n][l]=r>1?t[n][l]*e[n][l]:[t[n][l]*e[n][l]];return h}}static MultiplyConstant(t,e=1){for(var r=t[0].length,i=t.length,s=this.Create(i,r),a=0;a<i;a++)for(var h=0;h<r;h++)s[a][h]=e*t[a][h];return s}static Add(t,e,r=1){var i=t[0].length,s=t.length,a=e[0].length,h=e.length;if(i==a&&s==h){for(var n=this.Create(s,i),l=0;l<s;l++)for(var o=0;o<i;o++)n[l][o]=t[l][o]+r*e[l][o];return n}}static AddConstant(t,e=0){for(var r=t[0].length,i=t.length,s=this.Create(i,r),a=0;a<i;a++)for(var h=0;h<r;h++)s[a][h]=t[a][h]+e;return s}static Sum(t){for(var e=0,r=0;r<Ay;r++)for(var i=0;i<Ax;i++)e+=t[r][i];return e}static SquareSum(t){for(var e=0,r=0;r<Ay;r++)for(var i=0;i<Ax;i++)e+=t[r][i]*t[r][i];return e}static Mean(t,e){if(1===e){for(var r=this.Create(t[0].length),i=0;i<t[0].length;i++){for(var s=0,a=0;a<t.length;a++)s+=t[a][i];r[i]=s/t.length}return r}for(r=this.Create(t.length),a=0;a<t.length;a++){for(s=0,i=0;i<t[0].length;i++)s+=t[a][i];r[a]=s/t[0].length}return r}static Sigmoid(t){return 1/(1+Math.exp(-t))}static Diff(t,e){var r=t[0].length,i=t.length,s=e[0].length,a=e.length;if(r==s&&i==a){for(var h=this.Create(i,r),n=0;n<i;n++)for(var l=0;l<r;l++)h[n][l]=t[n][l]-e[n][l];return h}}static Sigm(t){for(var e=t[0].length,r=t.length,i=this.Create(r,e),s=0;s<r;s++)for(var a=0;a<e;a++)i[s][a]=this.Sigmoid(t[s][a]);return i}static DSigm(t){for(var e=t[0].length,r=t.length,i=this.Create(r,e),s=0;s<r;s++)for(var a=0;a<e;a++){var h=this.Sigmoid(t[s][a]);i[s][a]=h*(1-h)}return i}static CBind(t,e){var r=t[0].length,i=t.length,s=e[0].length;if(i==e.length){var a=r+s,h=i,n=this.Create(h,a);return this.Copy2DOffset(n,t,0,0),this.Copy2DOffset(n,e,r,0),n}}static Flip(t,e){for(var r=t.length,i=t[0].length,s=t[0][0].length,a=this.Create(r,i,s),h=0;h<r;h++)for(var n=0;n<i;n++)for(var l=0;l<s;l++)switch(e){case 0:a[h][n][l]=t[h][n][s-l-1];break;case 1:a[h][n][l]=t[h][i-n-1][l];break;case 2:a[h][n][l]=t[r-h-1][n][l];break;default:a[h][n][l]=t[h][n][s-l-1]}return a}static Flip2D(t,e){for(var r=t.length,i=t[0].length,s=this.Create(r,i),a=0;a<r;a++)for(var h=0;h<i;h++)switch(e){case 0:s[a][h]=t[a][i-h-1];break;case 1:s[a][h]=t[r-a-1][h];break;default:s[a][h]=t[a][i-h-1]}return s}static FlipAll(t){for(var e=t.length,r=t[0].length,i=t[0][0].length,s=this.Create(e,r,i),a=this.Clone(t),h=0;h<3;h++)s=this.Flip(a,h),a=this.Clone(s);return s}static Rotate180(t){for(var e=this.Create(t.length,t[0].length),r=this.Clone(t),i=0;i<2;i++)e=this.Flip2D(r,i),r=this.Clone(e);return e}static Expand(t,e,r){for(var i=t[0].length*e,s=t.length*r,a=this.Create(s,i),h=0;h<t.length;h++)for(var n=0;n<t[0].length;n++)for(var l=0;l<r;l++)for(var o=0;o<e;o++)a[h*r+l][n*e+o]=t[h][n];return a}static Vector(t){for(var e=this.Transpose(t),r=this.Create(t.length*t[0].length),i=0,s=0;s<e.length;s++)for(t=0;t<e[0].length;t++)r[i]=e[s][t],i++;return r}static RowSums(t){for(var e=this.Create(t.length),r=0;r<t.length;r++){e[r]=0;for(var i=0;i<t[0].length;i++)e[r]+=t[r][i]}return e}static ColSums(t){for(var e=this.Create(t[0].length),r=0;r<t[0].length;r++){e[r]=0;for(var i=0;i<t.length;i++)e[r]+=t[i][r]}return e}static Diag(t){if(t>0){for(var e=this.Create(t,t),r=0;r<t;r++)for(var i=0;i<t;i++)e[r][i]=i==r?1:0;return e}}static Sqrt(t){for(var e=t[0].length,r=t.length,i=this.Create(r,e),s=0;s<r;s++)for(var a=0;a<e;a++)i[s][a]=Math.sqrt(t[s][a]);return i}static Set(t,e=0){for(var r=t[0].length,i=t.length,s=0;s<i;s++)for(var a=0;a<r;a++)t[s][a]=e}static Normalize(t){for(var e=t[0].length,r=t.length,i=this.Create(r,e),s=this.Create(e),a=this.Create(e),h=0;h<e;h++)s[h]=Number.MIN_VALUE,a[h]=Number.MAX_VALUE;for(var n=0;n<r;n++)for(h=0;h<e;h++)s[h]=Math.max(t[n][h],s[h]),a[h]=Math.min(t[n][h],a[h]);for(n=0;n<r;n++)for(h=0;h<e;h++){var l=s[h]-a[h];i[n][h]=(t[n][h]-a[h])/l}return{result:i,min:a,max:s}}static ApplyNormalization(t,e,r){for(var i=t[0].length,s=t.length,a=this.Create(s,i),h=0;h<s;h++)for(var n=0;n<i;n++){var l=e[n]-r[n];a[h][n]=(t[h][n]-r[n])/l}return a}}class NeuralNetworkOptions{constructor(t,e,r,i,s,a,h,n=!1){this.Alpha=t,this.Epochs=e,this.Inputs=i,this.Items=s,this.Categories=r,this.Tolerance=a,this.HiddenLayers=h<1||null==h?1:h,this.UseL2=n}}class HiddenLayer{constructor(t,e){this.Inputs=t,this.Outputs=e}}class DeepNeuralNetwork{constructor(){this.Layers=[],this.Weights=[],this.Deltas=[],this.Y=[],this.Y_true=[],this.X=[],this.Z=[],this.Activations=[],this.D=[],this.Cost=0,this.L2=0,this.Iterations=0,this.Max=0,this.Min=0}Forward(t){var e=Matrix.Create(t.length,1);Matrix.Set(e,1);for(var r=this.Weights.length-1,i=0;i<this.Weights.length;i++){var s=0==i?Matrix.CBind(e,t):Matrix.CBind(e,this.Activations[i-1]),a=Matrix.Transpose(this.Weights[i]),h=Matrix.Multiply(s,a);this.X[i]=s,this.Z[i]=h,i!=r?this.Activations[i]=Matrix.Sigm(h):this.Y=Matrix.Sigm(h)}}BackPropagation(t){var e=this.Weights.length-1;this.D[0]=Matrix.Diff(this.Y,this.Y_true);for(var r=1,i=e-1;i>=0;i--){var s=r-1,a=Matrix.Create(this.Weights[i+1].length,this.Weights[i+1][0].length-1),h=Matrix.DSigm(this.Z[i]);Matrix.Copy2D(a,this.Weights[i+1],1,0),this.D[r]=Matrix.Multiply(this.D[s],a),this.D[r]=Matrix.Product(this.D[r],h),r++}for(i=0;i<this.Weights.length;i++){var n=Matrix.Transpose(this.D[this.Weights.length-i-1]);this.Deltas[i]=Matrix.Multiply(n,this.X[i]),this.Deltas[i]=Matrix.MultiplyConstant(this.Deltas[i],1/t.length)}this.Cost=0,this.L2=0;for(var l=0;l<this.Y_true.length;l++)for(var o=0;o<this.Y_true[0].length;o++)this.L2+=this.D[0][l][o]*this.D[0][l][o]*.5,this.Cost+=-this.Y_true[l][o]*Math.log(this.Y[l][o])-(1-this.Y_true[l][o])*Math.log(1-this.Y[l][o]);this.Cost/=t.length,this.L2/=t.length}ApplyGradients(t){for(var e=0;e<this.Weights.length;e++)this.Weights[e]=Matrix.Add(this.Weights[e],this.Deltas[e],-t.Alpha)}Rand(t,e){for(var r=Matrix.Create(e,t),i=0;i<e;i++)for(var s=0;s<t;s++)r[i][s]=2*(Math.random()-.5);return r}Labels(t,e){for(var r=Matrix.Create(e.Items,e.Categories),i=Matrix.Diag(e.Categories),s=0;s<e.Items;s++)if(e.Categories>1)for(var a=0;a<e.Categories;a++)r[s][a]=i[Math.abs(parseInt(t[s]))-1][a];else r[s]=t[s];return r}Predict(t,e){this.Forward(t);for(var r=Matrix.Create(t.length),i=0;i<t.length;i++)if(e.Categories>1){for(var s=Number.MIN_VALUE,a=0;a<e.Categories;a++){var h=this.Y[i][a];h>s&&(s=h)}r[i]=[s]}else r[i]=this.Y[i];return r}Classify(t,e,r=.5){this.Forward(t);for(var i=Matrix.Create(t.length),s=0;s<t.length;s++)if(e.Categories>1){for(var a=Number.MIN_VALUE,h=0,n=0;n<e.Categories;n++){var l=this.Y[s][n];l>a&&(a=l,h=n)}i[s]=[h+1]}else i[s]=this.Y[s]>r?[1]:[0];return i}SetupLabels(t,e){this.Y_true=this.Labels(t,e)}SetupHiddenLayers(t,e,r){if(r.length>0){this.Layers=[],this.Layers.push(new HiddenLayer(t,r[0]));for(var i=1;i<r.length;i++)this.Layers.push(new HiddenLayer(r[i-1],r[i]));this.Layers.push(new HiddenLayer(r[r.length-1],e))}}Setup(t,e,r=!0){if(r){if(null!=this.Activations&&this.Activations.length>0)for(var i=0;i<this.Activations.length;i++)this.Activations[i]=[];if(null!=this.D&&this.D.length>0)for(i=0;i<this.D.length;i++)this.D[i]=[];if(null!=this.Deltas&&this.Deltas.length>0)for(i=0;i<this.Deltas.length;i++)this.Deltas[i]=[];if(null!=this.X&&this.X.length>0)for(i=0;i<this.X.length;i++)this.X[i]=[];if(null!=this.Z&&this.Z.length>0)for(i=0;i<this.Z.length;i++)this.Z[i]=[];if(null!=this.Weights&&this.Weights.length>0)for(i=0;i<this.Weights.length;i++)this.Weights[i]=[];if(this.Layers.length>0){this.Weights=Matrix.Create(this.Layers.length);for(i=0;i<this.Layers.length;i++)this.Weights[i]=Matrix.Create(this.Layers[i].Outputs,this.Layers[i].Inputs+1)}else{this.Weights=Matrix.Create(e.HiddenLayers+1),this.Weights[0]=Matrix.Create(e.Inputs+1,e.Nodes);for(i=1;i<e.HiddenLayers;i++)this.Weights[i]=Matrix.Create(e.Nodes+1,e.Nodes);this.Weights[e.HiddenLayers]=Matrix.Create(e.Categories,e.Nodes+1)}}if(this.Activations=Matrix.Create(e.HiddenLayers),this.Deltas=Matrix.Create(e.HiddenLayers+1),this.X=Matrix.Create(e.HiddenLayers+1),this.D=Matrix.Create(e.HiddenLayers+1),this.Z=Matrix.Create(e.HiddenLayers+1),this.SetupLabels(t,e),r&&null!=this.Weights)for(i=0;i<e.HiddenLayers+1;i++)this.Weights[i]=this.Rand(this.Weights[i][0].length,this.Weights[i].length);this.Cost=1,this.L2=1,this.Iterations=0}Step(t,e){this.Forward(t),this.BackPropagation(t);var r=isNaN(e.UseL2?this.L2:this.Cost)||(e.UseL2?this.L2:this.Cost)<e.Tolerance;return r||this.ApplyGradients(e),this.Iterations++,r||this.Iterations>=e.Epochs}Train(t,e,r){for(this.Setup(e,r);!this.Step(t,r););}Normalize(t){var e=Matrix.Normalize(t);return this.Min=e.min,this.Max=e.max,e.result}ApplyNormalization(t){return Matrix.ApplyNormalization(t,this.Max,this.Min)}}
