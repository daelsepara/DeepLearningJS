angular.module("d3",[]).factory("d3Service",[function(){return d3}]),angular.module("DeepLearning",["ngWebworker","ngFileSaver","d3"]).controller("NeuralNetworksController",["$scope","Webworker","FileSaver","Blob",function(e,t,n,i){e.Network={},e.NetworkOptions={},e.HiddenLayerNodes=[],e.Classification=[],e.Prediction=[],e.TrainingData=[],e.Output=[],e.Inputs=0,e.Categories=0,e.Items=0,e.hiddenLayerNodes=4,e.LearningRate=2,e.Epochs=1e4,e.Tolerance=1e-4,e.UseL2=!0,e.TestData=[],e.Samples=0,e.Threshold=.9,e.Training=!1,e.SelectedFile={},e.TestFile={},e.NetworkFile={},e.DelimiterNames=["Tab \\t","Comma ,","Space \\s","Vertical Pipe |","Colon :","Semi-Colon ;","Forward Slash /","/","Backward Slash \\"],e.Delimiters=["\t",","," ","|",":",";","/","\\"],e.delimiter=e.DelimiterNames[0],e.SelectedDelimiter=0,e.ToggleNodeText=!1,e.Width=1024,e.Height=1024,e.NodeSize=30,e.SelectDelimeter=function(){var t=e.DelimiterNames.indexOf(e.delimiter);e.SelectedDelimiter=t+1},e.AddHiddenLayer=function(){e.HiddenLayerNodes.push(parseInt(e.hiddenLayerNodes))},e.RemoveHiddenLayer=function(t){e.HiddenLayerNodes.length>0&&t>=0&t<e.HiddenLayerNodes.length&&e.HiddenLayerNodes.splice(t,1)},e.RemoveAllHiddenLayers=function(){e.HiddenLayerNodes=[]},e.ReadTestData=function(){e.TestData=[],e.Samples=0;var t=new FileReader;t.onload=function(n){e.$apply(function(){for(var n=t.result.split("\n"),i=e.SelectedDelimiter>0?e.Delimiters[e.SelectedDelimiter-1]:"\t",r=0;r<n.length;r++){var a=[],s=n[r].trim().split(i);if(s.length>=e.Inputs){for(var o=0;o<s.length;o++)o>=0&&o<e.Inputs&&a.push(parseFloat(s[o]));a.length>0&&(e.TestData.push(a),e.Samples++)}}e.testContent=t.result.trim()})},null!=e.TestFile.name&&t.readAsText(e.TestFile)},e.ReadTrainingData=function(){e.TrainingData=[],e.Output=[],e.Items=0,e.Categories=0,e.Inputs=0;var t=new FileReader;t.onload=function(n){e.$apply(function(){for(var n=t.result.split("\n"),i=e.SelectedDelimiter>0?e.Delimiters[e.SelectedDelimiter-1]:"\t",r=0;r<n.length;r++){var a=[],s=n[r].trim().split(i);if(s.length>0){if(0==r&&s.length>1&&(e.Inputs=s.length-1),s.length>1){var o=parseInt(s[s.length-1]);e.Categories=Math.max(e.Categories,o),e.Output.push([o])}for(var l=0;l<s.length-1;l++)a.push(parseFloat(s[l]));a.length>0&&(e.TrainingData.push(a),e.Items++)}}e.fileContent=t.result.trim()})},null!=e.SelectedFile.name&&t.readAsText(e.SelectedFile)},e.Initialize=function(){},e.asyncTrainer=void 0,e.asyncClassifier=void 0,e.StopAsyncTrainer=function(){if(e.asyncTrainer)try{e.asyncTrainer.terminate(),e.asyncTrainer=null,e.Training=!1,e.TrainingProgress=0}catch(t){e.asyncTrainer=null,e.Training=!1,e.TrainingProgress=0}},e.StopAsyncClassifier=function(){if(e.asyncClassifier)try{e.asyncClassifier.terminate(),e.asyncClassifier=null,e.ClassifierProgress=0}catch(t){e.asyncTrainer=null,e.ClassifierProgress=0}},e.PrettyPrint=function(e){return JSON.stringify(e,void 0,4)},e.AsyncTrainer=function(){if(!e.Training&&e.Items>0&&e.Inputs>0&&e.Categories>0&&e.HiddenLayerNodes.length>0&&e.TrainingData.length>0&&e.Output.length>0){var n=document.URL;e.Training=!0,e.asyncTrainer=t.create(function(e,t,n,i,r,a,s,o,l){importScripts(e+"js/Models.min.js");var c=new DeepNeuralNetwork,u=c.Normalize(t),d=new NeuralNetworkOptions(i,r,a,u[0].length,u.length,s,o.length,l);for(c.SetupHiddenLayers(u[0].length,d.Categories,o),c.Setup(n,d);!c.Step(u,d);)c.Iterations%1e3==0&&notify({Iterations:c.Iterations,L2:c.L2,Cost:c.Cost});complete({network:c,opts:d})},{async:!0}),e.asyncTrainer.run(n,e.TrainingData,e.Output,e.LearningRate,e.Epochs,e.Categories,e.Tolerance,e.HiddenLayerNodes,e.UseL2).then(function(t){e.Network=t.network,e.NetworkOptions=t.opts,e.TrainingProgress=1,e.Training=!1,e.networkWeights=e.PrettyPrint(e.Network.Weights)},null,function(t){e.TrainingProgress=t.Iterations/e.Epochs,e.Network.L2=t.L2,e.Network.Iterations=t.Iterations,e.Network.Cost=t.Cost}).catch(function(t){e.asyncTrainer=null})}},e.AsyncClassifier=function(){if(!e.Training&&e.Samples>0&&e.Inputs>0&&e.TestData.length>0&&null!=e.Network&&null!=e.NetworkOptions){var n=document.URL;e.asyncClassifier=t.create(function(e,t,n,i,r){importScripts(e+"js/Models.js");var a=new DeepNeuralNetwork;a.Activations=Matrix.Create(i.HiddenLayers),a.X=Matrix.Create(i.HiddenLayers+1),a.Z=Matrix.Create(i.HiddenLayers+1),a.Weights=n.Weights,a.Min=n.Min,a.Max=n.Max;var s=a.ApplyNormalization(t),o=a.Classify(s,i,r),l=a.Predict(s,i);complete({classification:o,prediction:l})},{async:!0}),e.asyncClassifier.run(n,e.TestData,e.Network,e.NetworkOptions,e.Threshold).then(function(t){if(e.classificationResult="",null!=t.classification){e.Classification=t.classification;for(var n=0;n<e.Classification.length;n++)n>0&&(e.classificationResult+="\n"),e.classificationResult+=e.Classification[n][0].toString()}null!=t.prediction&&(e.Prediction=t.prediction),e.ClassifierProgress=1},null,function(e){}).catch(function(t){e.asyncClassifier=null})}},e.SaveNetwork=function(){if(null!=e.Network.Weights){var t={Weights:e.Network.Weights,Normalization:[e.Network.Min,e.Network.Max]},r=JSON.stringify(t),a=new i([r],{type:"application/json"});n.saveAs(a,"Network.json")}},e.LoadNetwork=function(){e.Network={},e.Inputs=0,e.Categories=0;var t=new FileReader;t.onload=function(n){e.$apply(function(){var n=JSON.parse(t.result);if(null!=n.Weights&&null!=n.Normalization){e.Network={Weights:n.Weights,Min:n.Normalization[0],Max:n.Normalization[1]},e.Inputs=n.Weights[0][0].length-1,e.Categories=n.Weights[n.Weights.length-1].length,e.HiddenLayerNodes=[];for(var i=0;i<n.Weights.length-1;i++)e.HiddenLayerNodes.push(n.Weights[i].length);e.NetworkOptions={HiddenLayers:e.HiddenLayerNodes.length,Categories:e.Categories},e.networkWeights=e.PrettyPrint(n.Weights)}})},null!=e.NetworkFile.name&&t.readAsText(e.NetworkFile)},e.RenderNetwork=function(){if(null!=e.Network.Weights){for(var t={nodes:[]},n=0;n<e.Inputs;n++)t.nodes.push({label:"i["+(n+1).toString()+"]",layer:1});for(n=0;n<e.Network.Weights.length-1;n++)for(var i=0;i<e.Network.Weights[n].length;i++)t.nodes.push({label:"h["+(n+1).toString()+"]["+(i+1).toString()+"]",layer:n+2});for(n=0;n<e.Categories;n++)t.nodes.push({label:"o["+(n+1).toString()+"]",layer:e.Network.Weights.length+1});var r=e.Width,a=e.Height,s=e.NodeSize,o=d3.scaleOrdinal(d3.schemeCategory10),l=d3.select("#viz").attr("width",r).attr("height",a);l.selectAll("*").remove();var c=t.nodes,u={};c.forEach(function(e){e.layer in u?u[e.layer]+=1:u[e.layer]=1,e.lidx=u[e.layer]});var d=0;for(n=0;n<c.length;n++)d=Math.max(d,c[n].lidx);var g=Math.max.apply(null,Object.keys(u).map(function(e){return u[e]})),f=r/Object.keys(u).length,p=a/g;c.map(function(e){e.x=(e.layer-.5)*f,e.y=(Math.floor((d-u[e.layer])/2)+e.lidx-.5)*p});var h=[];c.map(function(e,t){for(var n in c)e.layer+1==c[n].layer&&h.push({source:parseInt(t),target:parseInt(n),value:1})}).filter(function(e){return void 0!==e});l.selectAll(".link").data(h).enter().append("line").attr("class","link").attr("x1",function(e){return c[e.source].x}).attr("y1",function(e){return c[e.source].y}).attr("x2",function(e){return c[e.target].x}).attr("y2",function(e){return c[e.target].y}).style("stroke-width",function(e){return Math.sqrt(e.value)});var y=l.selectAll(".node").data(c).enter().append("g").attr("transform",function(e){return"translate("+e.x+","+e.y+")"});y.append("circle").attr("class","node").attr("r",s).style("fill",function(e){return o(e.layer)});e.ToggleNodeText&&y.append("text").attr("text-anchor","middle").attr("dx","-.35em").attr("dy",".35em").text(function(e){return e.label})}},e.SaveRender=function(){var e=$("#viz")[0].innerHTML;if(null!=e){(e='<svg><style type="text/css"> text { pointer-events: none; } .node:hover { stroke: #999; stroke-opacity: .6; stroke-width: 4px; } .link { stroke: #999; stroke-opacity: .6;\t} </style>'+e+"</svg>").match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)||(e=e.replace(/^<svg/,'<svg xmlns="http://www.w3.org/2000/svg"')),e.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)||(e=e.replace(/^<svg/,'<svg xmlns:xlink="http://www.w3.org/1999/xlink"'));var t=new i([e],{type:"image/svg+xml;charset=utf-8"});n.saveAs(t,"Network.svg")}}}]).directive("filelistBind",function(){return function(e,t,n){t.bind("change",function(t){e.$apply(function(e){e[n.name]=t.target.files,e.Items=0,e.Categories=0,e.Inputs=0,e.SelectedFile=t.target.files[0]})})}}).directive("testfileBind",function(){return function(e,t,n){t.bind("change",function(t){e.$apply(function(e){e[n.name]=t.target.files,e.Samples=0,e.TestFile=t.target.files[0]})})}}).directive("networkfileBind",function(){return function(e,t,n){t.bind("change",function(t){e.$apply(function(e){e[n.name]=t.target.files,e.NetworkFile=t.target.files[0]})})}});
