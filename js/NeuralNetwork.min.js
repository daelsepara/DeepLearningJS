angular.module("DeepLearning",["ngWebworker"]).controller("NeuralNetworksController",["$scope","Webworker",function(e,t){e.Network={},e.NetworkOptions={},e.HiddenLayerNodes=[],e.Classification=[],e.Prediction=[],e.TrainingData=[],e.Output=[],e.Inputs=0,e.Categories=0,e.Items=0,e.hiddenLayerNodes=4,e.LearningRate=2,e.Epochs=1e4,e.Tolerance=1e-4,e.TestData=[],e.Samples=0,e.Threshold=.9,e.Training=!1,e.SelectedFile={},e.TestFile={},e.DelimiterNames=["Tab \\t","Comma ,","Space \\s","Vertical Pipe |","Colon :","Semi-Colon ;","Forward Slash /","/","Backward Slash \\"],e.Delimiters=["\t",","," ","|",":",";","/","\\"],e.delimiter=e.DelimiterNames[0],e.SelectedDelimiter=0,e.SelectDelimeter=function(){var t=e.DelimiterNames.indexOf(e.delimiter);e.SelectedDelimiter=t+1},e.AddHiddenLayer=function(){e.HiddenLayerNodes.push(parseInt(e.hiddenLayerNodes))},e.RemoveHiddenLayer=function(t){e.HiddenLayerNodes.length>0&&t>=0&t<e.HiddenLayerNodes.length&&e.HiddenLayerNodes.splice(t,1)},e.RemoveAllHiddenLayers=function(){e.HiddenLayerNodes=[]},e.ReadTestData=function(){e.TestData=[],e.Samples=0;var t=new FileReader;t.onload=function(i){e.$apply(function(){for(var i=t.result.split("\n"),n=e.SelectedDelimiter>0?e.Delimiters[e.SelectedDelimiter-1]:"\t",r=0;r<i.length;r++){var a=[],s=i[r].trim().split(n);if(s.length>=e.Inputs){for(var l=0;l<s.length;l++)l>=0&&l<e.Inputs&&a.push(parseFloat(s[l]));a.length>0&&(e.TestData.push(a),e.Samples++)}}e.testContent=t.result.trim()})},null!=e.TestFile.name&&t.readAsText(e.TestFile)},e.ReadTrainingData=function(){e.TrainingData=[],e.Output=[],e.Items=0,e.Categories=0,e.Inputs=0;var t=new FileReader;t.onload=function(i){e.$apply(function(){for(var i=t.result.split("\n"),n=e.SelectedDelimiter>0?e.Delimiters[e.SelectedDelimiter-1]:"\t",r=0;r<i.length;r++){var a=[],s=i[r].trim().split(n);if(s.length>0){if(0==r&&s.length>1&&(e.Inputs=s.length-1),s.length>1){var l=parseInt(s[s.length-1]);e.Categories=Math.max(e.Categories,l),e.Output.push([l])}for(var o=0;o<s.length-1;o++)a.push(parseFloat(s[o]));a.length>0&&(e.TrainingData.push(a),e.Items++)}}e.fileContent=t.result.trim()})},null!=e.SelectedFile.name&&t.readAsText(e.SelectedFile)},e.Initialize=function(){},e.asyncTrainer=void 0,e.asyncClassifier=void 0,e.StopAsyncTrainer=function(){if(e.asyncTrainer)try{e.asyncTrainer.terminate(),e.asyncTrainer=null,e.Training=!1,e.TrainingProgress=0}catch(t){e.asyncTrainer=null,e.Training=!1,e.TrainingProgress=0}},e.StopAsyncClassifier=function(){if(e.asyncClassifier)try{e.asyncClassifier.terminate(),e.asyncClassifier=null,e.ClassifierProgress=0}catch(t){e.asyncTrainer=null,e.ClassifierProgress=0}},e.PrettyPrint=function(e){return JSON.stringify(e,void 0,4)},e.AsyncTrainer=function(){if(!e.Training&&e.Items>0&&e.Inputs>0&&e.Categories>0&&e.HiddenLayerNodes.length>0&&e.TrainingData.length>0&&e.Output.length>0){var i=document.URL;e.Training=!0,e.asyncTrainer=t.create(function(e,t,i,n,r,a,s,l){importScripts(e+"js/Models.min.js");var o=new DeepNeuralNetwork,c=o.Normalize(t),u=new NeuralNetworkOptions(n,r,a,c[0].length,c.length,s,l.length,!1);for(o.SetupHiddenLayers(c[0].length,u.Categories,l),o.Setup(i,u);!o.Step(c,u);)o.Iterations%1e3==0&&notify({Iterations:o.Iterations,L2:o.L2,Cost:o.Cost});complete({network:o,opts:u})},{async:!0}),e.asyncTrainer.run(i,e.TrainingData,e.Output,e.LearningRate,e.Epochs,e.Categories,e.Tolerance,e.HiddenLayerNodes).then(function(t){e.Network=t.network,e.NetworkOptions=t.opts,e.TrainingProgress=1,e.Training=!1,e.networkWeights=e.PrettyPrint(e.Network.Weights)},null,function(t){e.TrainingProgress=t.Iterations/e.Epochs,e.Network.L2=t.L2,e.Network.Iterations=t.Iterations,e.Network.Cost=t.Cost}).catch(function(t){e.asyncTrainer=null})}},e.AsyncClassifier=function(){if(!e.Training&&e.Samples>0&&e.Inputs>0&&e.TestData.length>0&&null!=e.Network&&null!=e.NetworkOptions){var i=document.URL;e.asyncClassifier=t.create(function(e,t,i,n,r){importScripts(e+"js/Models.js");var a=new DeepNeuralNetwork;a.Activations=Matrix.Create(n.HiddenLayers),a.X=Matrix.Create(n.HiddenLayers+1),a.Z=Matrix.Create(n.HiddenLayers+1),a.Weights=i.Weights,a.Min=i.Min,a.Max=i.Max;var s=a.ApplyNormalization(t),l=a.Classify(s,n,r),o=a.Predict(s,n);complete({classification:l,prediction:o})},{async:!0}),e.asyncClassifier.run(i,e.TestData,e.Network,e.NetworkOptions,e.Threshold).then(function(t){if(e.classificationResult="",null!=t.classification){e.Classification=t.classification;for(var i=0;i<e.Classification.length;i++)i>0&&(e.classificationResult+="\n"),e.classificationResult+=e.Classification[i][0].toString()}null!=t.prediction&&(e.Prediction=t.prediction),e.ClassifierProgress=1},null,function(e){}).catch(function(t){e.asyncClassifier=null})}}}]).directive("filelistBind",function(){return function(e,t,i){t.bind("change",function(t){e.$apply(function(e){e[i.name]=t.target.files,e.Items=0,e.Categories=0,e.Inputs=0,e.SelectedFile=t.target.files[0]})})}}).directive("testfileBind",function(){return function(e,t,i){t.bind("change",function(t){e.$apply(function(e){e[i.name]=t.target.files,e.Samples=0,e.TestFile=t.target.files[0]})})}});
