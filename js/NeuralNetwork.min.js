angular.module("DeepLearning",["ngWebworker"]).controller("NeuralNetworksController",["$scope","Webworker",function(e,t){e.Network={},e.NetworkOptions={},e.HiddenLayerNodes=[],e.Classification=[],e.Prediction=[],e.TrainingData=[],e.Output=[],e.Inputs=0,e.Categories=0,e.Items=0,e.hiddenLayerNodes=4,e.LearningRate=2,e.Epochs=1e4,e.Tolerance=1e-4,e.TestData=[],e.Samples=0,e.Threshold=.9,e.TrainingUploadProgress=0,e.TestUploadProgress=0,e.Training=!1,e.SelectedFile={},e.TestFile={},e.DelimiterNames=["Tab \\t","Comma ,","Space \\s","Vertical Pipe |","Colon :","Semi-Colon ;","Forward Slash /","/","Backward Slash \\"],e.Delimiters=["\t",","," ","|",":",";","/","\\"],e.delimiter="",e.SelectedDelimiter=0,e.SelectDelimeter=function(){var t=e.DelimiterNames.indexOf(e.delimiter);e.SelectedDelimiter=t+1},e.AddHiddenLayer=function(){e.HiddenLayerNodes.push(parseInt(e.hiddenLayerNodes))},e.RemoveHiddenLayer=function(t){e.HiddenLayerNodes.length>0&&t>=0&t<e.HiddenLayerNodes.length&&e.HiddenLayerNodes.splice(t,1)},e.ReadTestData=function(){e.TestData=[],e.Samples=0;var t=new FileReader;t.onload=function(n){e.TestUploadProgress=n.loaded/n.total,e.$apply(function(){for(var n=t.result.split("\n"),i=e.SelectedDelimiter>0?e.Delimiters[e.SelectedDelimiter-1]:"\t",a=0;a<n.length;a++){var r=[],s=n[a].trim().split(i);if(s.length>=e.Inputs){for(var l=0;l<s.length;l++)l>=0&&l<e.Inputs&&r.push(parseFloat(s[l]));r.length>0&&(e.TestData.push(r),e.Samples++)}}e.testContent=t.result.trim()})},null!=e.TestFile.name&&t.readAsText(e.TestFile)},e.ReadTrainingData=function(){e.TrainingData=[],e.Output=[],e.Items=0,e.Categories=0,e.Inputs=0;var t=new FileReader;t.onload=function(n){e.TrainingUploadProgress=n.loaded/n.total,e.$apply(function(){for(var n=t.result.split("\n"),i=e.SelectedDelimiter>0?e.Delimiters[e.SelectedDelimiter-1]:"\t",a=0;a<n.length;a++){var r=[],s=n[a].trim().split(i);if(s.length>0){if(0==a&&s.length>1&&(e.Inputs=s.length-1),s.length>1){var l=parseInt(s[s.length-1]);e.Categories=Math.max(e.Categories,l),e.Output.push([l])}for(var o=0;o<s.length-1;o++)r.push(parseFloat(s[o]));r.length>0&&(e.TrainingData.push(r),e.Items++)}}e.fileContent=t.result.trim()})},null!=e.SelectedFile.name&&t.readAsText(e.SelectedFile)},e.Initialize=function(){},e.asyncTrainer=void 0,e.asyncClassifier=void 0,e.StopAsyncTrainer=function(){if(e.asyncTrainer)try{e.asyncTrainer.terminate(),e.asyncTrainer=null,e.Training=!1,e.TrainingProgress=0}catch(t){e.asyncTrainer=null,e.Training=!1,e.TrainingProgress=0}},e.StopAsyncClassifier=function(){if(e.asyncClassifier)try{e.asyncClassifier.terminate(),e.asyncClassifier=null,e.ClassifierProgress=0}catch(t){e.asyncTrainer=null,e.ClassifierProgress=0}},e.AsyncTrainer=function(){if(!e.Training&&e.Items>0&&e.Inputs>0&&e.Categories>0&&e.HiddenLayerNodes.length>0&&e.TrainingData.length>0&&e.Output.length>0){var n=document.URL;e.Training=!0,e.asyncTrainer=t.create(function(e,t,n,i,a,r,s,l){importScripts(e+"js/Models.js");var o=new DeepNeuralNetwork,c=o.Normalize(t),d=new NeuralNetworkOptions(i,a,r,c[0].length,c.length,s,l.length,!1);for(o.SetupHiddenLayers(c[0].length,d.Categories,l),o.Setup(n,d);!o.Step(c,d);)o.Iterations%1e3==0&&notify({Iterations:o.Iterations,L2:o.L2,Cost:o.Cost});complete({network:o,opts:d})},{async:!0}),e.asyncTrainer.run(n,e.TrainingData,e.Output,e.LearningRate,e.Epochs,e.Categories,e.Tolerance,e.HiddenLayerNodes).then(function(t){e.Network=t.network,e.NetworkOptions=t.opts,e.TrainingProgress=1,e.Training=!1},null,function(t){e.TrainingProgress=t.Iterations/e.Epochs,e.Network.L2=t.L2,e.Network.Iterations=t.Iterations,e.Network.Cost=t.Cost}).catch(function(t){e.asyncTrainer=null})}},e.AsyncClassifier=function(){if(!e.Training&&e.Samples>0&&e.Inputs>0&&e.TestData.length>0&&null!=e.Network&&null!=e.NetworkOptions){var n=document.URL;e.asyncClassifier=t.create(function(e,t,n,i,a){importScripts(e+"js/Models.js");var r=new DeepNeuralNetwork;r.Activations=Matrix.Create(i.HiddenLayers),r.X=Matrix.Create(i.HiddenLayers+1),r.Z=Matrix.Create(i.HiddenLayers+1),r.Weights=n.Weights,r.Min=n.Min,r.Max=n.Max;var s=r.ApplyNormalization(t),l=r.Classify(s,i,a);complete({classification:l})},{async:!0}),e.asyncClassifier.run(n,e.TestData,e.Network,e.NetworkOptions,e.Threshold).then(function(t){if(e.classificationResult="",null!=t.classification)for(var n=0;n<t.classification.length;n++)n>0&&(e.classificationResult+="\n"),e.classificationResult+=t.classification[n][0].toString();e.ClassifierProgress=1},null,function(e){}).catch(function(t){e.asyncClassifier=null})}}}]).directive("filelistBind",function(){return function(e,t,n){t.bind("change",function(t){e.$apply(function(e){e[n.name]=t.target.files,e.TrainingUploadProgress=0,e.Items=0,e.Categories=0,e.Inputs=0,e.SelectedFile=t.target.files[0]})})}}).directive("testfileBind",function(){return function(e,t,n){t.bind("change",function(t){e.$apply(function(e){e[n.name]=t.target.files,e.TestUploadProgress=0,e.Samples=0,e.TestFile=t.target.files[0]})})}});
