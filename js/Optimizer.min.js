class Optimizer{constructor(){this.RHO=.01,this.SIG=.5,this.INT=.1,this.EXT=3,this.MAX=20,this.RATIO=100,this.Red=1,this.s=[],this.df1=[],this.MaxIterations=0,this.Iterations=0,this.Evaluations=0,this.length=0,this.M=0,this.iteration=0,this.ls_failed=!1,this.f1=0,this.X0=[],this.DF0=[],this.d1=0,this.z1=0}ReshapeWeights(t){var i=[];if(null!=t&&t.length>0)for(var s=0;s<t.length;s++)for(var h=0;h<t[s][0].length;h++)for(var e=0;e<t[s].length;e++)i.push(t[s][e][h]);return i}RevertWeights(t,i){for(var s=0,h=0;h<i.length;h++)for(var e=0;e<i[h][0].length;e++)for(var a=0;a<i[h].length;a++)s<t.length&&(i[h][a][e]=t[s]),s++}OptimizerCost(t,i,s){return this.RevertWeights(s,t.Weights),t.Forward(i),t.BackPropagation(i),s=this.ReshapeWeights(t.Deltas),{Cost:t.Cost,Gradient:s}}SetupOptimizer(t,i,s,h,e=!0){t.Setup(s,h,e),this.MaxIterations=h.Epochs;var a=this.ReshapeWeights(t.Weights);this.Setup(t,i,a)}StepOptimizer(t,i,s){var h=this.ReshapeWeights(t.Weights);return this.Step(t,i,h),this.Cost=this.f1,isNaN(this.Cost)||this.Iterations>=s.Epochs||this.Cost<s.Tolerance}Multiply(t,i){var s=0;if(t.length==i.length)for(var h=0;h<t.length;h++)s+=t[h]*i[h];return s}Add(t,i,s=1){if(t.length==i.length)for(var h=0;h<t.length;h++)t[h]+=s*i[h]}Copy(t,i,s=1){if(t.length==i.length)for(var h=0;h<t.length;h++)t[h]=s*i[h]}Setup(t,i,s){this.s=Matrix.Create(s.length),this.Evaluations=0,this.Iterations=0,this.length=this.MaxIterations,this.M=0,this.iteration=0,this.ls_failed=!1;var h=this.OptimizerCost(t,i,s);this.f1=h.Cost,this.df1=h.Gradient,this.Evaluations++,this.length<0&&this.iteration++,this.Copy(this.s,this.df1,-1),this.d1=-this.Multiply(this.s,this.s),this.z1=this.Red/(1-this.d1),this.X0=Matrix.Create(s.length),this.DF0=Matrix.Create(s.length)}Step(t,i,s){this.length>0&&this.iteration++,this.Iterations=this.iteration,this.Copy(this.X0,s),this.Copy(this.DF0,this.df1);this.f1;this.Add(s,this.s,this.z1);var h=this.OptimizerCost(t,i,s),e=h.Cost,a=h.Gradient;this.Evaluations++,this.length<0&&this.iteration++;var r=this.Multiply(a,this.s),n=this.f1,l=this.d1,o=-this.z1;this.length>0?this.M=this.MAX:this.M=Math.min(this.MAX,-this.length-this.iteration);for(var d=!1,f=-1;;){for(;(e>this.f1+this.z1*this.RHO*this.d1||r>-this.SIG*this.d1)&&this.M>0;){f=this.z1;var p=0,g=0,M=0;e>this.f1?M=o-.5*l*o*o/(l*o+e-n):(p=6*(e-n)/(o+3*(r+l)),g=3*(n-e)-o*((l+2)*r),M=Math.sqrt(g*g-p*r*o-g)/p),!isNaN(M)&&isFinite(M)||(M=o/2),M=Math.max(Math.min(M,this.INT*o),(1-this.INT)*o),this.z1=this.z1+M,this.Add(s,this.s,M),e=(h=this.OptimizerCost(t,i,s)).Cost,a=h.Gradient,this.Evaluations++,this.M=this.M-1,this.length<0&&this.iteration++,r=this.Multiply(a,this.s),o-=M}if(e>this.f1+this.z1*this.RHO*this.d1||r>-this.SIG*this.d1)break;if(r>this.SIG*this.d1){d=!0;break}if(0==this.M)break;var z=6*(e-n)/o+3*(r+l),u=3*(n-e)-o*(l+2*r),v=-r*o*o/(u+Math.sqrt(u*u-z*r*o*o));v<0&&(v*=-1),isNaN(v)||!isFinite(v)||v<0?v=f<-.5?this.z1*(this.EXT-1):(f-this.z1)/2:f>-.5&&v+this.z1>f?v=(f-this.z1)/2:f<-.5&&v+this.z1>this.z1*this.EXT?v=this.z1*(this.EXT-1):v<-o*this.INT?v=-o*this.INT:f>-.5&&v<(f-this.z1)*(1-this.INT)&&(v=(f-this.z1)*(1-this.INT)),n=e,l=r,o=-v,this.z1=this.z1+v,this.Add(s,this.s,v),a=(h=this.OptimizerCost(t,i,s)).Gradient,e=h.Cost,this.M=this.M-1,this.iteration=this.iteration+(this.length<0?1:0),r=this.Multiply(a,this.s)}if(d){this.f1=e;var C=this.Multiply(a,a),y=this.Multiply(this.df1,a),I=this.Multiply(this.df1,this.df1);this.Copy(this.s,this.s,(C-y)/I),this.Add(this.s,a,-1);var T=this.df1;this.df1=a,a=T,(r=this.Multiply(this.df1,this.s))>0&&(this.Copy(this.s,this.df1,-1),r=-this.Multiply(this.s,this.s)),this.z1=this.z1*Math.min(this.RATIO,this.d1/(r-2.225074e-308)),this.d1=r,this.ls_failed=!1}else{if(this.f1=this.F0,this.Copy(s,this.X0),this.Copy(this.df1,this.DF0),this.ls_failed||this.iteration>Math.abs(this.length))return!0;T=this.df1;this.df1=a,a=T,this.Copy(this.s,this.df1,-1),this.d1=-this.Multiply(this.s,this.s),this.z1=1/(1-this.d1),this.ls_failed=!0}return!(this.iteration<Math.abs(this.length))}}
