class Optimizer{constructor(){this.RHO=.01,this.SIG=.5,this.INT=.1,this.EXT=3,this.MAX=20,this.RATIO=100,this.Red=1,this.s=[],this.df1=[],this.MaxIterations=0,this.Iterations=0,this.Evaluations=0,this.length=0,this.M=0,this.iteration=0,this.ls_failed=!1,this.f1=0,this.X0=[],this.DF0=[],this.d1=0,this.z1=0}ReshapeWeights(t){var i=[];if(null!=t&&t.length>0)for(var s=0;s<t.length;s++)for(var h=0;h<t[s][0].length;h++)for(var e=0;e<t[s].length;e++)i.push(t[s][e][h]);return i}RevertWeights(t,i){for(var s=0,h=0;h<i.length;h++)for(var e=0;e<i[h][0].length;e++)for(var a=0;a<i[h].length;a++)s<t.length&&(i[h][a][e]=t[s]),s++}OptimizerCost(t,i,s){return this.RevertWeights(s,t.Weights),t.Forward(i),t.BackPropagation(i),s=this.ReshapeWeights(t.Deltas),{Cost:t.Cost,Gradient:s}}SetupOptimizer(t,i,s,h,e=!0){t.Setup(s,h,e),this.MaxIterations=h.Epochs;var a=this.ReshapeWeights(t.Weights);this.Setup(t,i,a)}StepOptimizer(t,i,s){var h=this.ReshapeWeights(t.Weights);return this.Step(t,i,h),this.Cost=this.f1,isNaN(this.Cost)||this.Iterations>=s.Epochs||this.Cost<s.Tolerance}Multiply(t,i){var s=0;if(t.length==i.length)for(var h=0;h<t.length;h++)s+=t[h]*i[h];return s}Add(t,i,s=1){if(t.length==i.length)for(var h=0;h<t.length;h++)t[h]+=s*i[h]}Copy(t,i,s=1){if(t.length==i.length)for(var h=0;h<t.length;h++)t[h]=s*i[h]}Setup(t,i,s){this.s=Matrix.Create(s.length),this.Evaluations=0,this.Iterations=0,this.length=this.MaxIterations,this.M=0,this.iteration=0,this.ls_failed=!1;var h=this.OptimizerCost(t,i,s);this.f1=h.Cost,this.df1=h.Gradient,this.Evaluations++,this.length<0&&this.iteration++,this.Copy(this.s,this.df1,-1),this.d1=-this.Multiply(this.s,this.s),this.z1=this.Red/(1-this.d1),this.X0=Matrix.Create(s.length),this.DF0=Matrix.Create(s.length)}Step(t,i,s){this.length>0&&this.iteration++,this.Iterations=this.iteration,this.Copy(this.X0,s),this.Copy(this.DF0,this.df1);var h=this.f1;this.Add(s,this.s,this.z1);var e=this.OptimizerCost(t,i,s),a=e.Cost,r=e.Gradient;this.Evaluations++,this.length<0&&this.iteration++;var n=this.Multiply(r,this.s),l=this.f1,o=this.d1,d=-this.z1;this.length>0?this.M=this.MAX:this.M=Math.min(this.MAX,-this.length-this.iteration);for(var f=!1,p=-1;;){for(;(a>this.f1+this.z1*this.RHO*this.d1||n>-this.SIG*this.d1)&&this.M>0;){p=this.z1;var g=0,M=0,z=0;a>this.f1?z=d-.5*o*d*d/(o*d+a-l):(g=6*(a-l)/(d+3*(n+o)),M=3*(l-a)-d*((o+2)*n),z=Math.sqrt(M*M-g*n*d-M)/g),!isNaN(z)&&isFinite(z)||(z=d/2),z=Math.max(Math.min(z,this.INT*d),(1-this.INT)*d),this.z1=this.z1+z,this.Add(s,this.s,z),a=(e=this.OptimizerCost(t,i,s)).Cost,r=e.Gradient,this.Evaluations++,this.M=this.M-1,this.length<0&&this.iteration++,n=this.Multiply(r,this.s),d-=z}if(a>this.f1+this.z1*this.RHO*this.d1||n>-this.SIG*this.d1)break;if(n>this.SIG*this.d1){f=!0;break}if(0==this.M)break;var u=6*(a-l)/d+3*(n+o),v=3*(l-a)-d*(o+2*n),C=-n*d*d/(v+Math.sqrt(v*v-u*n*d*d));C<0&&(C*=-1),isNaN(C)||!isFinite(C)||C<0?C=p<-.5?this.z1*(this.EXT-1):(p-this.z1)/2:p>-.5&&C+this.z1>p?C=(p-this.z1)/2:p<-.5&&C+this.z1>this.z1*this.EXT?C=this.z1*(this.EXT-1):C<-d*this.INT?C=-d*this.INT:p>-.5&&C<(p-this.z1)*(1-this.INT)&&(C=(p-this.z1)*(1-this.INT)),l=a,o=n,d=-C,this.z1=this.z1+C,this.Add(s,this.s,C),r=(e=this.OptimizerCost(t,i,s)).Gradient,a=e.Cost,this.M=this.M-1,this.iteration=this.iteration+(this.length<0?1:0),n=this.Multiply(r,this.s)}if(f){this.f1=a;var y=this.Multiply(r,r),I=this.Multiply(this.df1,r),T=this.Multiply(this.df1,this.df1);this.Copy(this.s,this.s,(y-I)/T),this.Add(this.s,r,-1);var N=this.df1;this.df1=r,r=N,(n=this.Multiply(this.df1,this.s))>0&&(this.Copy(this.s,this.df1,-1),n=-this.Multiply(this.s,this.s)),this.z1=this.z1*Math.min(this.RATIO,this.d1/(n-2.225074e-308)),this.d1=n,this.ls_failed=!1}else{if(this.f1=h,this.Copy(s,this.X0),this.Copy(this.df1,this.DF0),this.ls_failed||this.iteration>Math.abs(this.length))return!0;N=this.df1;this.df1=r,r=N,this.Copy(this.s,this.df1,-1),this.d1=-this.Multiply(this.s,this.s),this.z1=1/(1-this.d1),this.ls_failed=!0}return!(this.iteration<Math.abs(this.length))}}